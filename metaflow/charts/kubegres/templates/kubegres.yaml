apiVersion: kubegres.reactive-tech.io/v1
kind: Kubegres
metadata:
  name: {{ include "kubegres.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "metaflow.labels" . | nindent 4 }}
  annotations:
    {{- include "metaflow.annotations" . | nindent 4 }}
  
spec:
  replicas: {{ .Values.replicas }}
  image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
  port: {{ .Values.port }}

  {{- if .Values.imagePullSecrets }}
  imagePullSecrets:
    {{- range $v := .Values.imagePullSecrets }}
    - name: {{ $v.name }}
    {{- end }}
  {{- end }}
  database:
    size: {{ .Values.size }}
    {{ if .Values.storageClassName }}storageClassName: {{ .Values.storageClassName }}{{- end }}
    {{ if .Values.volumeMount }}volumeMount: {{ .Values.volumeMount }}{{- end }}
  {{ if .Values.customConfigMap }}customConfig: {{ .Values.customConfigMap }}{{- end }}
  failover:
    isDisabled: {{ not .Values.failoverEnabled }}
    {{ if .Values.promotePodToPrimary }}promotePod: {{ .Values.promotePodToPrimary }}{{- end}}
    
  {{- if .Values.backup.enabled }}
  backup:
    schedule: {{ .Values.backup.schedule }}
    pvcName: {{ if .Values.backup.backupPvcName }}{{ .Values.backup.backupPvcName }}{{ else }}{{ $.Release.Name }}-kubegres-backup-pvc{{- end }}
    volumeMount: {{ .Values.backup.backupVolumeMount }}
  {{- end }}
  env:
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "kubegres.secret.name" . }}
          key: {{ include "kubegres.secret.primaryValue" . }}
          
    - name: POSTGRES_REPLICATION_PASSWORD
      valueFrom:
        secretKeyRef:
          name: {{ include "kubegres.secret.name" . }}
          key: {{ include "kubegres.secret.replicaValue" . }}

  {{- if .Values.environmentVariables }}
  {{- range $v := .environmentVariables }}
    - name: {{ $v.name }}
      value: {{ $v.value | quote }}
  {{- end }}
  {{- end }}